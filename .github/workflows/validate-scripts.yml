name: Validate scripts on PR (checks only)

permissions:
  contents: read

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'scripts/**'

jobs:
  validate-meta:
    name: Validate meta.yml in changed script dirs and run sh/ps1 checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head (validate the branch to be merged)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          set -euo pipefail
          BASE=${{ github.event.pull_request.base.ref }}
          echo "Base branch: $BASE"
          git fetch origin $BASE:refs/remotes/origin/$BASE

      - name: Get changed files in PR
        id: changed-files
        run: |
          set -euo pipefail
          BASE=${{ github.event.pull_request.base.ref }}
          # list files changed in the PR (only files changed on the PR branch vs base)
          git diff --name-only origin/$BASE...HEAD > changed.txt || true
          # normalize and dedupe
          sed -n '/./p' changed.txt | sort -u > changed_sorted.txt || true
          echo "files<<EOF" >> $GITHUB_OUTPUT
          sed 's/%/%%/g' changed_sorted.txt >> $GITHUB_OUTPUT || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Filter script dirs to validate
        id: scripts-to-validate
        run: |
          set -euo pipefail
          if [ ! -f changed_sorted.txt ]; then
            echo "list=" >> $GITHUB_OUTPUT
            exit 0
          fi
          files=$(cat changed_sorted.txt)
          scripts=$(printf "%s\n" "$files" | grep '^scripts/' || true)
          if [ -z "$scripts" ]; then
            echo "No changes under scripts/, nothing to validate."
            echo "list=" >> $GITHUB_OUTPUT
            exit 0
          fi
          # extract unique script directories (scripts/<name>)
          dirs=$(printf "%s\n" "$scripts" | awk -F/ '{print $1"/"$2}' | sort -u | tr '\n' ',' | sed 's/,$//')
          echo "Scripts to validate: $dirs"
          echo "list=$dirs" >> $GITHUB_OUTPUT

      - name: Validate meta.yml presence for changed scripts
        run: |
          set -euo pipefail
          to_check="${{ steps.scripts-to-validate.outputs.list }}"
          if [ -z "$to_check" ]; then
            echo "No scripts to check."
            exit 0
          fi
          IFS=',' read -r -a arr <<< "$to_check"
          errors=0
          for d in "${arr[@]}"; do
            if [ ! -f "$d/meta.yml" ] && [ ! -f "$d/meta.yaml" ]; then
              echo "- $d: missing meta.yml"
              errors=1
            else
              echo "OK: $d/meta.yml exists"
            fi
          done
          if [ "$errors" -ne 0 ]; then
            echo "Validation failed."
            exit 1
          fi

      - name: Run shell & PowerShell static and format checks on changed scripts
        run: |
          set -euo pipefail

          if [ ! -f changed_sorted.txt ]; then
            echo "No changed files list found, skipping shell/ps1 checks."
            exit 0
          fi

          mapfile -t SH_FILES < <(cat changed_sorted.txt | grep -E '\\/.+\\.sh$' || true)
          mapfile -t PS1_FILES < <(cat changed_sorted.txt | grep -E '\\/.+\\.ps1$' || true)

          if [ ${#SH_FILES[@]} -eq 0 ] && [ ${#PS1_FILES[@]} -eq 0 ]; then
            echo "No .sh or .ps1 files changed in this PR. Skipping shell/ps1 checks."
            exit 0
          fi

          if [ ${#SH_FILES[@]} -gt 0 ]; then
            echo "Shell files to check: ${SH_FILES[*]}"
            sudo apt-get update
            sudo apt-get install -y shellcheck curl

            SHFMT_VER="v3.6.1"
            curl -sL -o /usr/local/bin/shfmt "https://github.com/mvdan/sh/releases/download/${SHFMT_VER}/shfmt_${SHFMT_VER#v}_linux_amd64"
            sudo chmod +x /usr/local/bin/shfmt || true

            UNFORMATTED=""
            for f in "${SH_FILES[@]}"; do
              if [ -f "$f" ]; then
                out=$(shfmt -l "$f" || true)
                if [ -n "$out" ]; then
                  UNFORMATTED="$UNFORMATTED\n$out"
                fi
              else
                # file may have been deleted in PR, skip
                echo "Skipping missing file $f"
              fi
            done

            if [ -n "$(echo -n "$UNFORMATTED" )" ]; then
              echo "shfmt found unformatted files:$UNFORMATTED"
              echo "Run: shfmt -w <file> to fix formatting"
              exit 1
            fi

            echo "Running shellcheck..."
            # run shellcheck on existing files
            for f in "${SH_FILES[@]}"; do
              if [ -f "$f" ]; then
                shellcheck -x "$f"
              fi
            done
          fi

          if [ ${#PS1_FILES[@]} -gt 0 ]; then
            echo "PowerShell files to check: ${PS1_FILES[*]}"
            pwsh -NoProfile -Command "Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber -SkipPublisherCheck"
            PS_FAIL=0
            for f in "${PS1_FILES[@]}"; do
              if [ -f "$f" ]; then
                echo "Analyzing $f"
                pwsh -NoProfile -Command "if ((Invoke-ScriptAnalyzer -Path '$f' -Severity @('Error','Warning')).Count -gt 0) { Write-Output 'ISSUES'; exit 1 } else { exit 0 }" || PS_FAIL=1
              fi
            done
            if [ "$PS_FAIL" -ne 0 ]; then
              echo "PSScriptAnalyzer found issues in one or more .ps1 files"
              exit 1
            fi
          fi
