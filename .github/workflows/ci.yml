name: CI - Shellcheck, shfmt, Tests

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect shell scripts and tests
        id: detect
        run: |
          set -e
          files=$(git ls-files '*.sh' | tr '\n' ' ')
          has_sh=0
          has_tests=0
          if [ -n "$files" ]; then
            has_sh=1
          fi
          if [ -f ./test/run.sh ]; then
            has_tests=1
          fi
          if [ "$has_sh" -eq 0 ] && [ "$has_tests" -eq 0 ]; then
            echo "No shell scripts or tests found, skipping entire job."
            echo "has_work=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_work=true" >> $GITHUB_OUTPUT

      - name: Install tools (shellcheck, shfmt)
        if: steps.detect.outputs.has_work == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          # install shfmt binary
          SHFMT_VERSION=v3.6.1
          curl -sSL "https://github.com/mvdan/sh/releases/download/${SHFMT_VERSION}/shfmt_${SHFMT_VERSION}_linux_amd64" -o shfmt
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/shfmt

      - name: Run shellcheck on all .sh files
        if: steps.detect.outputs.has_work == 'true'
        run: |
          set -e
          files=$(git ls-files '*.sh' | tr '\n' ' ')
          if [ -z "$files" ]; then
            echo "No shell scripts found, skipping shellcheck."
          else
            echo "Running shellcheck on: $files"
            shellcheck -x $files
          fi

      - name: Run shfmt (check formatting)
        if: steps.detect.outputs.has_work == 'true'
        run: |
          set -e
          files=$(git ls-files '*.sh' | tr '\n' ' ')
          if [ -z "$files" ]; then
            echo "No shell scripts found, skipping shfmt."
          else
            echo "Checking shfmt for: $files"
            if ! shfmt -d $files; then
              echo "shfmt reported differences. Run 'shfmt -w' to fix them."
              exit 1
            fi
          fi

      - name: Run project tests (if present)
        if: steps.detect.outputs.has_work == 'true'
        run: |
          if [ -f ./test/run.sh ]; then
            echo "Running project tests"
            chmod +x ./test/run.sh
            ./test/run.sh
          else
            echo "No test runner found at ./test/run.sh, skipping tests."
          fi
