name: Update scripts index

# Trigger regeneration also when this workflow changes (to feed Pages later)
# Added comment line to retrigger and integrate with Pages deployment.

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/update-index.yml'

permissions:
  contents: write

jobs:
  build_and_commit_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Make indexer executable
        run: chmod +x tools/indexer/generate_index.sh || true

      - name: Run index generator
        run: tools/indexer/generate_index.sh

      - name: Stage generated files
        run: |
          git add scripts.json index.html || true

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit generated index files
        if: steps.check_changes.outputs.changed == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: "chore: update scripts index"
          add: |
            scripts.json
            index.html