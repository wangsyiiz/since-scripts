name: Update scripts index

# Trigger regeneration also when this workflow changes (to feed Pages later)
# Added comment line to retrigger and integrate with Pages deployment.
#
# NOTE: To push to a protected main branch, you need to set up one of the following:
# 1. Create a PAT (Personal Access Token) with 'repo' scope and add it as a repository secret named 'REPO_PAT'
#    The PAT owner must have permission to bypass branch protection rules
# 2. Or create a GitHub App with Contents: write permission and use the app token
# 3. Or add a branch protection bypass rule for GitHub Actions in the repository settings

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/update-index.yml'

permissions:
  contents: write

jobs:
  build_and_commit_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Use PAT if available to bypass branch protection, otherwise use GITHUB_TOKEN
          token: ${{ secrets.REPO_PAT || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Make indexer executable
        run: chmod +x tools/indexer/generate_index.sh || true

      - name: Run index generator
        run: tools/indexer/generate_index.sh

      - name: Stage generated files
        run: |
          git add scripts.json index.html || true

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit generated index files
        if: steps.check_changes.outputs.changed == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: "chore: update scripts index"
          add: |
            scripts.json
            index.html