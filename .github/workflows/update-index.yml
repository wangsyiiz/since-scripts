name: Update scripts index

# Trigger regeneration also when this workflow changes (to feed Pages later)
# Added comment line to retrigger and integrate with Pages deployment.

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - '.github/workflows/update-index.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_commit_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Make indexer executable
        run: chmod +x tools/indexer/generate_index.sh || true

      - name: Run index generator
        run: tools/indexer/generate_index.sh

      - name: Commit and push changes
        run: |
          # Check if either file has been modified by the indexer
          if [ -f scripts.json ] && [ -f index.html ]; then
            if git diff --quiet scripts.json index.html; then
              echo "No changes detected, skipping commit"
            else
              # Configure git
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              
              # Stage and commit changes
              git add scripts.json index.html
              git commit -m "chore: update scripts index"
              
              # Push changes directly to main
              git push
              
              echo "Changes committed and pushed successfully"
            fi
          else
            echo "One or more files not found, skipping..."
          fi